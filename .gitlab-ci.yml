stages:
  - lint
  - test
  - build
  - package
  - release

variables:
  GOFLAGS: "-count=1"
  CARGO_TARGET_DIR: "target"
  RUST_BACKTRACE: "1"

# Cache dependencies for faster builds
cache:
  paths:
    - .go/pkg/mod/
    - target/
    - omni/target/

# Format and lint checks
fmt:
  stage: lint
  image: golang:1.22
  script:
    - cd omni
    - make fmt
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

lint:
  stage: lint
  image: golang:1.22
  script:
    - cd omni
    - make lint
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# Rust linting
rust-lint:
  stage: lint
  image: rust:1.70
  script:
    - cd omni/native/clift
    - cargo fmt --check
    - cargo clippy -- -D warnings
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# Security scanning
security-scan:
  stage: lint
  image: golang:1.22
  script:
    - cd omni
    - go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest
    - gosec ./...
    - go install golang.org/x/vuln/cmd/govulncheck@latest
    - govulncheck ./...
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# Code quality checks
code-quality:
  stage: lint
  image: golang:1.22
  script:
    - cd omni
    - go install honnef.co/go/tools/cmd/staticcheck@latest
    - staticcheck ./...
    - go install github.com/gordonklaus/ineffassign@latest
    - ineffassign ./...
    - go install github.com/kisielk/errcheck@latest
    - errcheck ./...
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# Run all tests
test:
  stage: test
  image: golang:1.22
  before_script:
    - apt-get update && apt-get install -y gcc curl
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source $HOME/.cargo/env
    - rustup default stable
  script:
    - cd omni
    - make build-rust
    - export LD_LIBRARY_PATH=$PWD/native/clift/target/release:$LD_LIBRARY_PATH
    - # Skip CGO tests in CI to avoid linking issues
    - CGO_ENABLED=0 make test
  coverage: '/coverage: \d+\.\d+%/'
  artifacts:
    paths:
      - omni/coverage/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# Test Rust components
rust-test:
  stage: test
  image: rust:1.70
  script:
    - cd omni/native/clift
    - cargo test --verbose
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# Integration testing with real OmniLang programs
integration-test:
  stage: test
  image: golang:1.22
  before_script:
    - apt-get update && apt-get install -y gcc curl
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source $HOME/.cargo/env
    - rustup default stable
  script:
    - cd omni
    - make build-rust
    - make build
    - export LD_LIBRARY_PATH=$PWD/native/clift/target/release:$LD_LIBRARY_PATH
    - # Test basic compilation
    - echo 'func main():int { return 42 }' > test_basic.omni
    - ./bin/omnic -emit exe test_basic.omni -o test_basic
    - ./test_basic
    - # Test assembly generation
    - ./bin/omnic -emit asm test_basic.omni -o test_basic.s
    - test -f test_basic.s
    - # Test optimization levels
    - ./bin/omnic -O O2 -emit exe test_basic.omni -o test_basic_opt
    - ./test_basic_opt
    - # Test debug symbols
    - ./bin/omnic -debug -emit exe test_basic.omni -o test_basic_debug
    - ./test_basic_debug
    - # Cleanup
    - rm -f test_basic* test_basic.s
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# Performance benchmarking
benchmark:
  stage: test
  image: golang:1.22
  before_script:
    - apt-get update && apt-get install -y gcc curl
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source $HOME/.cargo/env
    - rustup default stable
  script:
    - cd omni
    - make build-rust
    - make build
    - export LD_LIBRARY_PATH=$PWD/native/clift/target/release:$LD_LIBRARY_PATH
    - # Run benchmarks if they exist
    - if [ -d "tests/bench" ]; then make bench; fi
  artifacts:
    paths:
      - omni/bench-results/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# Build for Linux x86_64
build-linux:
  stage: build
  image: golang:1.22
  before_script:
    - cd omni
    - apt-get update && apt-get install -y gcc curl
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source $HOME/.cargo/env
    - rustup default stable
  script:
    - make build-rust
    - make build
    - export LD_LIBRARY_PATH=$PWD/native/clift/target/release:$LD_LIBRARY_PATH
    - make test
  artifacts:
    paths:
      - omni/bin/
      - omni/target/release/
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# Build for macOS (using Linux with cross-compilation)
build-macos:
  stage: build
  image: golang:1.22
  before_script:
    - cd omni
    - apt-get update && apt-get install -y gcc curl
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source $HOME/.cargo/env
    - rustup default stable
  script:
    - make build-rust
    - GOOS=darwin GOARCH=amd64 make build
    - GOOS=darwin GOARCH=arm64 make build
  artifacts:
    paths:
      - omni/bin/
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# Build for Windows
build-windows:
  stage: build
  image: golang:1.22
  before_script:
    - cd omni
    - apt-get update && apt-get install -y gcc curl
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source $HOME/.cargo/env
    - rustup default stable
  script:
    - make build-rust
    - GOOS=windows GOARCH=amd64 make build
  artifacts:
    paths:
      - omni/bin/
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# Create distribution package
package:
  stage: package
  image: golang:1.22
  dependencies:
    - build-linux
    - build-macos
    - build-windows
  before_script:
    - cd omni
    - apt-get update && apt-get install -y zip tar gzip curl
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source $HOME/.cargo/env
    - rustup default stable
  script:
    - make build-rust
    - make package
  artifacts:
    paths:
      - omni/dist/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# Create release
release:
  stage: release
  image: golang:1.22
  dependencies:
    - package
  script:
    - cd omni
    - make release
  rules:
    - if: $CI_COMMIT_TAG
  artifacts:
    paths:
      - omni/releases/
    expire_in: 1 month
