stages:
  - lint
  - test
  - build
  - package
  - release

variables:
  GOFLAGS: "-count=1"
  CARGO_TARGET_DIR: "target"
  RUST_BACKTRACE: "1"

# Cache dependencies for faster builds
cache:
  paths:
    - .go/pkg/mod/
    - target/
    - omni/target/

# Format and lint checks
fmt:
  stage: lint
  image: golang:1.22
  script:
    - cd omni
    - make fmt
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

lint:
  stage: lint
  image: golang:1.22
  script:
    - cd omni
    - make lint
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# Rust linting
rust-lint:
  stage: lint
  image: rust:1.70
  script:
    - cd omni/native/clift
    - cargo fmt --check
    - cargo clippy -- -D warnings
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# Run all tests
test:
  stage: test
  image: golang:1.22
  before_script:
    - apt-get update && apt-get install -y gcc curl
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source $HOME/.cargo/env
    - rustup default stable
  script:
    - cd omni
    - make build-rust
    - export LD_LIBRARY_PATH=$PWD/native/clift/target/release:$LD_LIBRARY_PATH
    - make test
  coverage: '/coverage: \d+\.\d+%/'
  artifacts:
    paths:
      - omni/coverage/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# Test Rust components
rust-test:
  stage: test
  image: rust:1.70
  script:
    - cd omni/native/clift
    - cargo test --verbose
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# Build for Linux x86_64
build-linux:
  stage: build
  image: golang:1.22
  before_script:
    - cd omni
    - apt-get update && apt-get install -y gcc curl
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source $HOME/.cargo/env
    - rustup default stable
  script:
    - make build-rust
    - make build
    - export LD_LIBRARY_PATH=$PWD/native/clift/target/release:$LD_LIBRARY_PATH
    - make test
  artifacts:
    paths:
      - omni/bin/
      - omni/target/release/
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# Build for macOS (using Linux with cross-compilation)
build-macos:
  stage: build
  image: golang:1.22
  before_script:
    - cd omni
    - apt-get update && apt-get install -y gcc curl
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source $HOME/.cargo/env
    - rustup default stable
  script:
    - make build-rust
    - GOOS=darwin GOARCH=amd64 make build
    - GOOS=darwin GOARCH=arm64 make build
  artifacts:
    paths:
      - omni/bin/
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# Build for Windows
build-windows:
  stage: build
  image: golang:1.22
  before_script:
    - cd omni
    - apt-get update && apt-get install -y gcc curl
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source $HOME/.cargo/env
    - rustup default stable
  script:
    - make build-rust
    - GOOS=windows GOARCH=amd64 make build
  artifacts:
    paths:
      - omni/bin/
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"

# Create distribution package
package:
  stage: package
  image: golang:1.22
  dependencies:
    - build-linux
    - build-macos
    - build-windows
  before_script:
    - cd omni
    - apt-get update && apt-get install -y zip tar gzip
  script:
    - make package
  artifacts:
    paths:
      - omni/dist/
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# Create release
release:
  stage: release
  image: golang:1.22
  dependencies:
    - package
  script:
    - cd omni
    - make release
  rules:
    - if: $CI_COMMIT_TAG
  artifacts:
    paths:
      - omni/releases/
    expire_in: 1 month
